{% extends 'base.html' %}
{% block title %} Job List {% endblock %}

{% block content %}  
<div class="container mt-4">
<h2 class="mb-4 text-teal fw-bold">Your Job Applications</h2>
<div class="container py-5">
  <div class="row g-4 justify-content-center">
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <div class="status-card bg-bookmarked">
        <h6>Bookmarked</h6>
        <p>{{ status_summary.Bookmarked|default:"0" }}</p>
      </div>
    </div>
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <div class="status-card bg-applying">
        <h6>Applying</h6>
        <p>{{ status_summary.Applying|default:"0" }}</p>
      </div>
    </div>
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <div class="status-card bg-applied">
        <h6>Applied</h6>
        <p>{{ status_summary.Applied|default:"0" }}</p>
      </div>
    </div>
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <div class="status-card bg-interview">
        <h6>Interviewing</h6>
        <p>{{ status_summary.Interviewing|default:"0" }}</p>
      </div>
    </div>
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <div class="status-card bg-negotiating">
        <h6>Negotiating</h6>
        <p>{{ status_summary.Negotiating|default:"0" }}</p>
      </div>
    </div>
    <div class="col-6 col-sm-4 col-md-3 col-lg-2">
      <div class="status-card bg-accepted">
        <h6>Accepted</h6>
        <p>{{ status_summary.Accepted|default:"0" }}</p>
      </div>
    </div>
  </div>
</div>
  <!-- Add Job Button -->
  <div class="mb-4 text-end">
    <button type="button" class="btn btn-teal shadow-sm" data-bs-toggle="modal" data-bs-target="#addJobModal">
      + Add New Job
    </button>
  </div>

  <div class="modal fade" id="addJobModal" tabindex="-1" aria-labelledby="addJobModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'add_jobs' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addJobModalLabel">Add New Job</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">Job Title</label>
            <input type="text" class="form-control" name="title" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Company</label>
            <input type="text" class="form-control" name="company" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Location</label>
            <input type="text" class="form-control" name="location" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Job URL</label>
            <input type="url" class="form-control" name="url">
          </div>

          <div class="mb-3">
            <label class="form-label">Salary</label>
            <input type="number" class="form-control" name="salary">
          </div>

          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" rows="3"></textarea>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Job</button>
        </div>
      </form>
    </div>
  </div>
</div>
<body>
  <div class="container">
    {% if jobs %}
    <div class="table-responsive">
      <table class="table table-hover table-striped align-middle shadow-sm bg-white">
        <thead class="table-dark">
          <tr>
            <th scope="col">Job Position</th>
            <th scope="col">Company</th>
            <th scope="col">Location</th>
            <th scope="col">Salary</th>
            <th scope="col">Status</th>
            <th scope="col">Date Saved</th>
            <th scope="col">Action</th>
          </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
              <tr >
                <td data-url="{% url 'job_detail' job.id %}" onclick="window.location.href=this.dataset.url" style="cursor: pointer;">{{job.title}}</td>
                <td data-url="{% url 'job_detail' job.id %}" onclick="window.location.href=this.dataset.url" style="cursor: pointer;">{{job.company}}</td>
                <td data-url="{% url 'job_detail' job.id %}" onclick="window.location.href=this.dataset.url" style="cursor: pointer;">{{job.location}}</td>
                <td>â‚¹ {{job.salary}}</td>
                <td>
             <div class="dropdown">
                <button id="status-btn-{{ job.id }}"
                        class="btn dropdown-toggle status-{{ job.status|lower }}"
                        type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  {{ job.status }}
                </button>

                <ul class="dropdown-menu">
                  {% for value, label in status_choices %}
                    <li>
                      <a href="javascript:void(0);" class="dropdown-item"
                        onclick="updateStatus('{{ job.id }}', '{{ value }}')">
                        {{ label }}
                      </a>
                    </li>
                  {% endfor %}
                </ul>
              </div>
                <td>{{job.date_saved}}</td>
                <td>
                  <div class="ms-3">
                  <a href="{% url 'update_job' job.id %}" class="text-decoration-none me-2">
                    <i class="bi bi-pencil-fill"></i>
                  </a>
                  <a href="{% url 'delete_job' job.id %}" class="text-decoration-none text-danger">
                    <i class="bi bi-trash-fill"></i>
                  </a>
                </div>
              </td>
              </tr>          
          </tbody>
            {% endfor %}
            {% else %}
            <h2>Please add a new job to track your job Application</h2>
          {% endif %}
      </table>
    </div>
  </div>       
</div>

<script>
  // Reset the "Add Job" form after submission
  const addJobForm = document.querySelector('#addJobModal form');

  if (addJobForm) {
    addJobForm.addEventListener('submit', () => {
      setTimeout(() => {
        addJobForm.reset();
      }, 100); 
    });
  }

  // Function to update job status using Fetch
function updateStatus(jobId, newStatus) {
  fetch(`/jobs/update_status/${jobId}/`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({ status: newStatus })
  })
  .then(response => {
    if (response.ok) {
      return response.json();
    }
    throw new Error("Network response was not ok.");
  })
  .then(data => {
    const button = document.querySelector(`#status-btn-${jobId}`);
    if (button) {
      button.textContent = data.status;
      // Remove old status classes
      button.classList.forEach(cls => {
        if (cls.startsWith('status-')) {
          button.classList.remove(cls);
        }
      });
      // Add new status class
      button.classList.add(`status-${data.status.toLowerCase()}`);
    }
  })
  .catch(error => {
    console.error('Error updating status:', error);
  });
}


  // Helper function to get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>

{% endblock %}

